<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Chat</title>
    <link href="./output.css" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script> -->
  </head>
  <body
    class="bg-gray-100 flex items-center justify-center w-screen h-screen flex-col"
  >
    <a class="absolute left-4 top-4 flex flex-row" href="./index.html">
      <i
        data-lucide="chevron-left"
        style="width: 24px; height: 24px; color: black"
      ></i>
      Go Back
    </a>
    <h1 class="text-xl md:text-2xl font-semibold text-blue-500 text-center">
      Real-Time Chat with a Doctor
    </h1>
    <div class="flex flex-col gap-4 w-screen md:w-[500px] p-4">
      <div
        id="messages"
        class="flex-1 min-h-[500px] max-h-[500x] overflow-y-scroll overlflow-x-hidden bg-white border rounded-xl"
      >
        <div id="response"></div>
      </div>
      <form id="form" class="flex flex-row gap-2">
        <input
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          id="message"
          type="text"
          placeholder="Message"
          required
        />
        <button
          id="send"
          type="submit"
          class="bg-blue-500 text-white px-4 py-2 rounded"
        >
          send
        </button>
      </form>
    </div>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      lucide.createIcons();
    </script>
    <script>
      var chatid = localStorage.getItem("chatid");
      const form = document.getElementById("form");
      const input = document.getElementById("message");
      const messages = document.getElementById("messages");
      const button = document.getElementById("send");
      let allMessages = [];
      let responseText = "";

      const sendMessage = async (message) => {
        input.innerHTML = "";
        button.ariaDisabled = true;
        input.innerHTML = "Sending...";
        input.ariaDisabled = true;
        responseText = "";
        allMessages = [
          ...allMessages,
          { sender: "user", message, timestamp: Date.now() },
        ];
        const data = await fetch(`http://172.20.103.161:3000/ollama`, {
          method: "POST",
          headers: {
            // "access-code": "2e49be06fd210b6e5682c61ab57795e8",
            // "user-id": "2de9fff728571194864b8490f66ea4e7",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            text: message,
          }),
        });
        const json = await data.json();
        const cleanMessage = await json.message.content
          .split("</think>")
          .slice(-1)[0];
        allMessages = [
          ...allMessages,
          {
            sender: "doctor",
            message: cleanMessage,
            timestamp: Date.now(),
          },
        ];
        showMessages();
        input.innerHTML = "";
        button.ariaDisabled = false;
        input.ariaDisabled = false;
      };
      document.getElementById("form").addEventListener("submit", (e) => {
        e.preventDefault();
        const message = document.getElementById("message").value;
        if (message != "") {
          sendMessage(message);
        }
      });

      const showMessages = () => {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";
        for (let i = 0; i < allMessages.length; i++) {
          const { sender, message, timestamp } = allMessages[i];
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("p-2", "rounded", "m-2", "bg-blue-100");
          messageDiv.innerHTML = `
            <p class="text-sm capitalize font-semibold text-blue-500">${sender}</p>
            <p class="text-sm text-gray-700">${message}</p>
            <p class="text-xs text-gray-500">${new Date(
              timestamp
            ).toLocaleString()}</p>
          `;
          messagesDiv.appendChild(messageDiv);
        }
      };
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      lucide.createIcons();
    </script>
  </body>
</html>
